### Terraform Network Booting

### Pre Requisites

Ubuntu MaaS Setup : ``
Ubuntu MaaS TFTP Setup: [pfSense - TFTP - MAAS](pfSense%20-%20TFTP%20-%20MAAS.md)

With Ubuntu MaaS setup and tftp settings setup to allow you to network boot any machines. you can follow along with these Terraform setup and apply configs. 

#### Configuring Terraform with Proxmox

As of the last update to this documentation the most recent Telmate/Proxmox plugin version for terraform is `2.9.11` to use this new version you will need a provider with the following structure.

```yml
terraform {
  required_version = ">=1.1.0"
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "2.9.11"
    }
  }
}

provider "proxmox" {
  pm_api_url          = "https://:8006/api2/json"
  pm_api_token_id     = ""
  pm_api_token_secret = ""
  pm_tls_insecure     = true
}
```

from above we have the terraform plugin setup script, this will tell terraform to download the plugin source `telmate/proxmox`, with version `2.9.11` and then set some provide details.

`pm_api_url` this needs to be either you only proxmox node, or a node that is connected to your cluster. an example would be `https://192.168.1.2:8006/api2/json` this will be where Terraform invokes its vm create, modify and destroy commands.

`pm_api_token_id` this is the id you gave to a new user for api access as per the image below you will need the username@realm so for me its packer@pam

![](Pasted%20image%2020230306142951.png)

`pm_api_token_secret` is the secret generated by adding a new token. In the second windows you see the Secret this goes into the `pm_api_token_secret` 

![](Pasted%20image%2020230306143117.png)
![](Pasted%20image%2020230306143131.png)
`these were deleted before writing this document :)`

`pm_tls_insecure` is set to true so terraform will bypass the self signed certificate and perform the work as per your requests. so to make all this happy we want to following provider

```yaml
terraform {
  required_version = ">=1.1.0"
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "2.9.11"
    }
  }
}

provider "proxmox" {
  pm_api_url          = "https://192.168.1.2:8006/api2/json"
  pm_api_token_id     = "api@oam!Obisidan-demo"
  pm_api_token_secret = "28f54f16-af19-4d91-8a2a-2687c57e2905"
  pm_tls_insecure     = true
}
```

We can then invoke this with `terraform init`. Which ever folder we have this provider file in we can start generating new machines, modify current ones, or remove no longer needed machines.

### Terraform Machine Configuration

To setup a new virtual machine within our proxmox agent or cluster we need a configuration file specific for our netboot needs. below is an example I use to spin up new virtual machines, which will use MaaS netboot/pxe to generate a new clean virtual machine.

```yaml
resource "proxmox_vm_qemu" "K3S-Test-2" {
  os_type     = "ubuntu"
  name        = "K3S-Test-2"
  agent       = 0
  boot        = "ndc"
  onboot      = true
  pxe         = true
  target_node = "venus"
  cores       = 2
  sockets     = 1
  cpu         = "host"
  memory      = 2048
  network {
    bridge   = "vmbr0"
    firewall  = false
    link_down = false
    model     = "virtio"
  }
  disk {
    type    = "scsi"
    storage = "vm"
    size    = "32G"
  }
}
```

Lets Break this yml down. 

`resource "proxmox_vm_qemu" "K3S-Test-2"` This is the initial setup for the resource. we have the type of object we will work with proxmox_vm_qemu is the vm portion of proxmox and will create a new virtual machine, proxmox_lxc can also be used in terraform via telmate to spin up new lxc containers from Terraform. I have chose vm creation.

The next few items are default and required
`os_type     = "ubuntu"` - this is the type of operating system we will be deploying. I believe this is default for linux, as we can also select centos or cloud-init
`name        = "K3S-Test-2"` - this is the name we will setup proxmox with. ![](./img/Pasted%20image%2020230306144851.png)
`agent       = 0` - This has failed in the past so setting the qemu_guest_agent to off helps with successfully installing. this can be changed after the fact to allow agent monitoring.
`boot        = "ndc"` - This is the most important part. I tried many ways to get this to work, and this is the only way I have found for the pxe booting to work. `ndc` or network, disk, cdrom as per the default in the documentation
![](./img/Pasted%20image%2020230306145438.png)

`onboot      = true` - This needs to be set to true/false based on if you want this machine to boot when the host is powered on, and quoram is reached.
`pxe         = true` - This needs to be true, as we are setting up a pxe virtual machine. 
`target_node = "venus"` - The node to run the machine on is also required. This only needs the node name inside of the cluster.

### Optional - but recommended

These next items are 

`cores       = 2` - Virtual Machine Cores To Provision

`sockets     = 1` - Virtual Machine CPU Sockets (on multiple servers you can give this cores on different sockets)

`cpu         = "host"` - The CPU Type - safe to pick host, some linux apps require specific cpu features.

`memory      = 2048` - 1024 * 2 simply the size of the ram you want to allocate

##### Network Section
`network { }`

`bridge   = "vmbr0"` - This is the host machines network physical port to connect to. This is usually the default name, however if its been changed this will most likely be wrong. Check the entwork section of your host.

`firewall  = false` - This sets the firewall active/disabled based on true/false

`link_down = false` - This will force the network link to be down on startup, we wont like that for network booting. :(

`model     = "virtio"` - This is the network model type, this again is default. 

##### Operating System Disks
Operating system disks I thoughy we were network booting. we are doing that but MaaS network boots, does some checks then lets you deploy Ubuntu to the machines disk, there by imaging a new vm, physical hardware without needing to install the operating system yourself.

`disk { }`

`type    = "scsi"` - This is the default disk type for most of proxmox.

`storage = "vm"` - This is the storage device name. On all my hosts I have one single drive called vm. where all my vm's store their operating disks. I do nightly backups for each machine. so to me this is safe. Also it means I can offline and Online Migrate to any host without needing to switch devices.

`size    = "32G"` - This is the size I want my linux vm's to have. So far I have not had issues with vm size.